<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Realtime AI Chatbot â€” Single File (Streaming)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--me:#0ea5a4}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #071b2a 100%);color:#e6eef8}
    .wrap{max-width:980px;margin:36px auto;padding:24px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:grid;place-items:center;font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    .chat-panel{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:18px}

    .main{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:18px;border-radius:12px;min-height:520px;display:flex;flex-direction:column}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:78%;display:flex;gap:10px;align-items:flex-end}
    .bubble{padding:12px 14px;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,0.5);line-height:1.35}
    .msg.user{margin-left:auto;flex-direction:row-reverse}
    .msg.user .bubble{background:linear-gradient(180deg,var(--me),#10b981);color:#04201f;border-bottom-right-radius:6px}
    .msg.bot .bubble{background:linear-gradient(180deg,#0b1220,#0a2540);color:#cfe8ff;border-bottom-left-radius:6px}
    .avatar{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:700}
    .avatar.bot{background:linear-gradient(135deg,#1e293b,#0ea5a4)}
    .avatar.user{background:linear-gradient(135deg,#065f46,#059669)}
    .time{font-size:11px;color:var(--muted);margin-top:6px}

    .input-area{display:flex;gap:10px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.03)}
    .input-area input{flex:1;padding:12px 14px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit}
    .input-area button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer}

    .side{min-height:520px;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
    .side h3{margin-top:0}
    .suggestions{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .chip:hover{transform:translateY(-2px)}
    .small{font-size:13px;color:var(--muted)}
    .typed{height:34px;display:flex;align-items:center;gap:6px}

    .typing{display:inline-flex;gap:3px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#a3e635;opacity:0.2;animation:blink 1s infinite}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes blink{0%,100%{opacity:0.15}50%{opacity:1}}

    @media (max-width:900px){.chat-panel{grid-template-columns:1fr}.side{order:2}.main{order:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AI</div>
      <div>
        <h1>Realtime AI Chatbot (Streaming)</h1>
        <p class="lead">Live token streaming via Server-Sent Events. Run the server and open this page from it: http://localhost:3000/realtime-chatbot.html</p>
      </div>
    </header>

    <div class="chat-panel">
      <main class="main">
        <div id="messages" class="messages" aria-live="polite"></div>

        <div class="input-area">
          <input id="prompt" placeholder="Type a message... (press Enter to send)" autocomplete="off" />
          <button id="sendBtn">Send</button>
        </div>
      </main>

      <aside class="side">
        <h3>Quick Prompts</h3>
        <div class="suggestions">
          <div class="chip">Summarize my notes</div>
          <div class="chip">Write a short poem about space</div>
          <div class="chip">Explain callbacks in JS</div>
          <div class="chip">Generate a friendly reply</div>
        </div>

        <h3 style="margin-top:18px">Settings</h3>
        <div class="small">Mode: <strong id="modeLabel">Server (streaming)</strong></div>
        <div style="margin-top:12px" class="small">Make sure you run the server (`server` folder) and add your OpenAI key to `.env`.</div>
      </aside>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const promptEl = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(text, who='bot', smallTime=''){
      const container = document.createElement('div');
      container.className = 'msg ' + (who==='user' ? 'user' : 'bot');

      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (who==='user' ? 'user' : 'bot');
      avatar.textContent = who==='user' ? 'U' : 'A';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = text.replace(/\n/g,'<br>');

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = smallTime || new Date().toLocaleTimeString();

      container.appendChild(avatar);
      container.appendChild(bubble);
      container.appendChild(time);

      messagesEl.appendChild(container);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return bubble;
    }

    function escapeHtml(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    // Send message using non-streaming fallback (POST) - useful if streaming fails
    async function sendMessageToAI_post(prompt){
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      return data.reply;
    }

    // Streaming version using EventSource (SSE)
    function sendMessageToAI_stream(prompt){
      return new Promise((resolve, reject) => {
        const encoded = encodeURIComponent(prompt);
        const url = `/api/chat/stream?prompt=${encoded}`;
        const es = new EventSource(url);
        let acc = '';
        // Create user msg then bot msg placeholder
        appendMessage(escapeHtml(prompt),'user');
        const botBubble = appendMessage('','bot');
        es.onmessage = (e) => {
          const data = e.data;
          if (data === '[DONE]') {
            es.close();
            resolve(acc);
          } else {
            // Append chunk to bubble (real-time typing)
            acc += data;
            botBubble.innerHTML = escapeHtml(acc).replace(/\n/g,'<br>');
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        };
        es.onerror = (err) => {
          es.close();
          reject(err);
        };
      });
    }

    async function handleSend(){
      const text = promptEl.value.trim();
      if(!text) return;
      promptEl.value = '';
      try {
        // Try streaming first
        await sendMessageToAI_stream(text);
      } catch (e) {
        // Fallback to non-streaming POST
        const reply = await sendMessageToAI_post(text);
        appendMessage(escapeHtml(reply),'bot');
      }
    }

    promptEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); } });
    sendBtn.addEventListener('click', handleSend);

    // quick chips
    document.querySelectorAll('.chip').forEach(c=>c.addEventListener('click', ()=>{ promptEl.value = c.textContent; promptEl.focus(); }));

    // initial welcome
    appendMessage('Welcome! Streaming mode enabled. Type something to see the token-by-token response.','bot');
  </script>
</body>
</html>
